# ============================================================
# HOPE GENOME - DOCKER COMPOSE
# ============================================================
#
# Usage:
#   docker-compose up hope-genome       # Run default (help)
#   docker-compose run hope-genome demo # Run demo
#   docker-compose run hope-genome test # Run tests
#
# Mate Robert + Claude
# VAS SZIGORA - 2026.01.01.
# ============================================================

version: '3.8'

services:
  # Main Hope Genome service
  hope-genome:
    build: .
    image: silentnoisehun/hope-genome:1.8.0
    container_name: hope-genome

    # Security Hardening
    security_opt:
      - "no-new-privileges:true"
    cap_drop:
      - ALL

    # Volumes for audit logs
    volumes:
      - ./audit_chain:/app/audit_chain

    # Environment
    environment:
      - HOPE_GENOME_VERSION=1.8.0
      - PYTHONUNBUFFERED=1

    # Interactive mode
    stdin_open: true
    tty: true

  # Audit service with persistent storage
  hope-audit:
    build: .
    image: silentnoisehun/hope-genome:1.8.0
    container_name: hope-audit
    command: audit

    security_opt:
      - "no-new-privileges:true"
    cap_drop:
      - ALL

    volumes:
      - audit-chain:/app/audit_chain

    environment:
      - HOPE_GENOME_VERSION=1.8.0

  # Production hardened service (with HSM support)
  hope-production:
    build: .
    image: silentnoisehun/hope-genome:1.8.0
    container_name: hope-production

    security_opt:
      - "no-new-privileges:true"
    cap_drop:
      - ALL
    read_only: true

    volumes:
      - audit-chain:/app/audit_chain
      - hope-logs:/var/log/hope_genome

    # HSM support (uncomment if using hardware security module)
    # devices:
    #   - "/dev/bus/usb:/dev/bus/usb"

    environment:
      - HOPE_GENOME_VERSION=1.8.0
      - RUST_LOG=info
      # HSM config (uncomment for production)
      # - PKCS11_MODULE_PATH=/usr/lib/softhsm/libsofthsm2.so
      # - PKCS11_TOKEN_LABEL=hope-token

volumes:
  audit-chain:
    driver: local
  hope-logs:
    driver: local
